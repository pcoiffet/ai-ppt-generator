<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI PPT Generator</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <span class="header-icon">ðŸ“Š</span>
        <div class="header-text">
          <h1>AI PPT GENERATOR</h1>
          <p class="subtitle">
            Describe your presentation, AI generates it for you.
          </p>
        </div>
      </div>

      <div class="chat-input-container">
        <textarea
          id="topicInput"
          class="chat-input"
          placeholder="Ex: A presentation about the impact of AI in healthcare..."
          rows="3"
        ></textarea>
      </div>

      <div class="settings-header">
        <span id="settingsToggle" class="settings-link"
          >Settings <span id="settingsChevron" class="chevron">â–¾</span></span
        >
      </div>

      <div id="settingsPanel" class="settings-panel" style="display: none">
        <div class="settings-grid">
          <div class="slider-row">
            <label for="slideCountInput"
              >Number of slides: <span id="slideCountValue">8</span></label
            >
            <input
              type="range"
              id="slideCountInput"
              min="5"
              max="15"
              value="8"
            />
          </div>

          <div class="select-row">
            <label for="languageSelect">Content language</label>
            <select id="languageSelect">
              <option value="en" selected>English</option>
              <option value="fr">FranÃ§ais</option>
            </select>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="generateBtn" class="btn btn-primary">
          <span>Generate</span>
        </button>

        <button id="downloadBtn" class="btn btn-primary btn-download">
          <span>Download</span>
        </button>
      </div>

      <div id="message"></div>
      <div id="progress" class="progress"></div>

      <!-- DEBUG -->
      <button id="debugBtn" class="debug-btn" title="View raw JSON">
        { }
      </button>

      <div id="debugModal" class="debug-modal">
        <div class="debug-modal-content">
          <div class="debug-modal-header">
            <h3>JSON Structure</h3>
            <button id="closeDebugBtn">Close</button>
          </div>
          <pre id="jsonContent" class="debug-modal-body"></pre>
        </div>
      </div>

      <!-- PREVIEW -->
      <div id="preview-container">
        <div class="preview-header">
          <h3>Content Preview</h3>
          <div class="preview-controls">
            <button id="prevSlide" class="btn-nav">&larr;</button>
            <span id="slideCount">1 / 5</span>
            <button id="nextSlide" class="btn-nav">&rarr;</button>
          </div>
        </div>
        <div id="slide-visual" class="slide-preview"></div>
      </div>
    </div>

    <script>
      const topicInput = document.getElementById("topicInput");
      const generateBtn = document.getElementById("generateBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const message = document.getElementById("message");
      const progress = document.getElementById("progress");
      const slideCountInput = document.getElementById("slideCountInput");
      const slideCountValue = document.getElementById("slideCountValue");

      const previewContainer = document.getElementById("preview-container");
      const slideVisual = document.getElementById("slide-visual");
      const prevBtn = document.getElementById("prevSlide");
      const nextBtn = document.getElementById("nextSlide");
      const slideCount = document.getElementById("slideCount");

      const debugBtn = document.getElementById("debugBtn");
      const debugModal = document.getElementById("debugModal");
      const closeDebugBtn = document.getElementById("closeDebugBtn");
      const jsonContent = document.getElementById("jsonContent");
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsChevron = document.getElementById("settingsChevron");
      const settingsPanel = document.getElementById("settingsPanel");
      const languageSelect = document.getElementById("languageSelect");

      let currentSlides = [];
      let currentSlideIndex = 0;
      let currentFileBase64 = null;
      let currentFilename = null;
      let currentJsonStructure = null;

      // Init download button
      downloadBtn.disabled = true;

      // Slider display
      slideCountInput.addEventListener("input", () => {
        slideCountValue.textContent = slideCountInput.value;
      });

      // Toggle settings
      settingsToggle.addEventListener("click", () => {
        const isOpen = settingsPanel.style.display === "block";
        settingsPanel.style.display = isOpen ? "none" : "block";
        settingsChevron.textContent = isOpen ? "â–¾" : "â–´";
      });

      // Keyboard shortcut Ctrl/Cmd + Enter
      topicInput.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          generateBtn.click();
        }
      });

      // Debug Modal
      debugBtn.addEventListener("click", () => {
        if (currentJsonStructure) {
          jsonContent.textContent = JSON.stringify(
            currentJsonStructure,
            null,
            2
          );
          debugModal.style.display = "flex";
        } else {
          alert("No JSON data available. Generate a presentation first.");
        }
      });

      closeDebugBtn.addEventListener("click", () => {
        debugModal.style.display = "none";
      });

      debugModal.addEventListener("click", (e) => {
        if (e.target === debugModal) debugModal.style.display = "none";
      });

      // Generate
      generateBtn.addEventListener("click", async () => {
        const topic = topicInput.value.trim();
        if (!topic) {
          message.innerHTML =
            '<div class="msg error">Please enter a topic.</div>';
          return;
        }

        generateBtn.disabled = true;
        downloadBtn.disabled = true;
        previewContainer.style.display = "none";

        generateBtn.innerHTML =
          '<div class="loading-spinner"></div><span>Generating...</span>';
        message.innerHTML = "";
        progress.textContent = "Step 1/2: Generating structure...";

        try {
          const response = await fetch("/generate-ppt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              topic: topic,
              slide_count: Number(slideCountInput.value),
              language: languageSelect.value,
            }),
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "Server error");

          progress.textContent = "Step 2/2: Preparing download...";

          currentFileBase64 = result.file_base64;
          currentFilename = result.filename;
          currentJsonStructure = result.structure;

          if (result.structure && result.structure.slides) {
            // Add title slide first
            const titleSlide = {
              title: result.structure.title || "Presentation",
              content: result.structure.subtitle || null,
              isTitleSlide: true,
            };
            currentSlides = [titleSlide, ...result.structure.slides];
            currentSlideIndex = 0;
            renderSlide(currentSlideIndex);
            previewContainer.style.display = "block";
          }

          downloadBtn.disabled = false;
          topicInput.value = "";
          progress.textContent = "";
        } catch (err) {
          console.error(err);
          message.innerHTML = `<div class="msg error">Error: ${err.message}</div>`;
          progress.textContent = "Error";
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = "<span>Regenerate</span>";
        }
      });

      // Download
      downloadBtn.addEventListener("click", () => {
        if (currentFileBase64 && currentFilename) {
          downloadBase64File(currentFileBase64, currentFilename);
        }
      });

      // Preview
      function renderSlide(index) {
        if (!currentSlides || currentSlides.length === 0) return;
        const slide = currentSlides[index];

        slideCount.textContent = `${index + 1} / ${currentSlides.length}`;

        let html = "";

        // Title slide
        if (slide.isTitleSlide) {
          html = `<div class="title-slide-content">`;
          html += `<div class="title-slide-main">${escapeHtml(
            slide.title
          )}</div>`;
          if (slide.content) {
            html += `<div class="title-slide-subtitle">${escapeHtml(
              String(slide.content)
            )}</div>`;
          }
          html += `</div>`;
        } else {
          // Normal slide
          html = `<div class="slide-title">${escapeHtml(slide.title)}</div>`;
          html += `<div class="slide-content">`;

          html += `<div class="slide-text-col">`;
          if (slide.content)
            html += `<p>${escapeHtml(String(slide.content))}</p>`;
          if (slide.bullet_points && slide.bullet_points.length > 0) {
            html += `<ul class="slide-bullets">`;
            slide.bullet_points.forEach((bp) => {
              const text = typeof bp === "string" ? bp : bp.text;
              html += `<li>${escapeHtml(text)}</li>`;
            });
            html += `</ul>`;
          }
          html += `</div>`;

          if (slide.image || slide.chart || slide.table) {
            html += `<div class="slide-visual-col">`;
            if (slide.image) html += `[Image: ${escapeHtml(slide.image.path)}]`;
            else if (slide.chart)
              html += `[Chart: ${escapeHtml(slide.chart.type)}]`;
            else if (slide.table)
              html += `[Table: ${slide.table.rows.length} rows]`;
            html += `</div>`;
          }

          html += `</div>`;
          html += `<div class="slide-footer">${index}</div>`;
        }

        slideVisual.innerHTML = html;
      }

      prevBtn.addEventListener("click", () => {
        if (currentSlideIndex > 0) {
          currentSlideIndex--;
          renderSlide(currentSlideIndex);
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentSlideIndex < currentSlides.length - 1) {
          currentSlideIndex++;
          renderSlide(currentSlideIndex);
        }
      });

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function downloadBase64File(base64Data, filename) {
        const bytes = Uint8Array.from(atob(base64Data), (c) => c.charCodeAt(0));
        const blob = new Blob([bytes], {
          type: "application/vnd.openxmlformats-officedocument.presentationml.presentation",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
